<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Sayfası</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="Siparis_Style.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <!-- Firebase config and initialization -->
    <script src="db.js"></script>

</head>


<body>

<div class="Container">

    <div class="kahdiv">
        <input type="radio" name="toggle" id="toggleOpen" value="toggleOpen">
        <input type="radio" name="toggle" id="toggleClose" value="toggleClose">
        <figure id="welcomeMessage">
          <figcaption>
            <h1> 
              <label for="toggleOpen"></label>
              <label for="toggleClose" title="Click to Close">✖</label>
              <b>
                -
                <a href="index.html" title="Anasayfa">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <defs>
                      <lineargradient id="svgGradient" x1="0" y1="0" x2="20" y2="0" gradientUnits="userSpaceOnUse">
                        <stop offset="0" stop-color="#00ffc3" />
                        <stop offset="0.09090909090909091" stop-color="#00fad9" />
                        <stop offset="0.18181818181818182" stop-color="#00f4f0" />
                        <stop offset="0.2727272727272727" stop-color="#00eeff" />
                        <stop offset="0.36363636363636365" stop-color="#00e6ff" />
                        <stop offset="0.4545454545454546" stop-color="#00dcff" />
                        <stop offset="0.5454545454545454" stop-color="#00d2ff" />
                        <stop offset="0.6363636363636364" stop-color="#00c5ff" />
                        <stop offset="0.7272727272727273" stop-color="#00b8ff" />
                        <stop offset="0.8181818181818182" stop-color="#6da8ff" />
                        <stop offset="0.9090909090909092" stop-color="#9f97ff" />
                        <stop offset="1" stop-color="#c285ff" />
                      </lineargradient>
                    </defs>
                    <path fill-rule="evenodd" d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6zm5-.793V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z" />
                    <path fill-rule="evenodd" d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z" />
                  </svg>
                </a>
              </b>
              <b>
                k
                <a href="AnaBilgi.html" title="Bilgi">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm8.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
                  </svg>
                </a>
              </b>
              <b>
                a
                <a href="javascript:void(0);" title="">
                  <svg class="svg-icon" viewBox="0 0 20 20">
                    <path d="M19.432,7.157c-0.312-1.113-1.624-1.858-3.496-2.17c0.279,0.331,0.532,0.685,0.754,1.06c1.043,0.299,1.748,0.764,1.911,1.344c0.095,0.335,0.014,0.729-0.24,1.169c-0.274,0.476-0.768,1.007-1.455,1.542c0-0.034,0.005-0.067,0.005-0.101c0-3.816-3.094-6.91-6.91-6.91c-3.816,0-6.91,3.094-6.91,6.91c0,1.169,0.293,2.268,0.805,3.232c-1.366-0.277-2.303-0.805-2.495-1.487c-0.094-0.336-0.013-0.729,0.241-1.169c0.138-0.239,0.35-0.496,0.595-0.756c0.011-0.449,0.055-0.89,0.138-1.317c-1.398,1.144-2.112,2.386-1.805,3.476c0.338,1.205,1.845,1.98,3.968,2.24C5.8,15.854,7.774,16.91,10,16.91c3.389,0,6.201-2.44,6.791-5.659C18.735,9.951,19.795,8.448,19.432,7.157 M10,16.047c-1.651,0-3.147-0.664-4.238-1.738c0.147,0.005,0.295,0.008,0.447,0.008c1.502,0,3.195-0.212,4.941-0.658c1.734-0.443,3.297-1.064,4.595-1.776C14.952,14.299,12.682,16.047,10,16.047 M15.998,10.733c-1.27,0.797-2.973,1.554-5.062,2.088c-1.616,0.414-3.251,0.632-4.727,0.632c-0.427,0-0.827-0.025-1.213-0.061C4.338,12.425,3.954,11.258,3.954,10c0-3.339,2.707-6.046,6.046-6.046c3.34,0,6.047,2.708,6.047,6.046C16.047,10.249,16.027,10.492,15.998,10.733"></path>
                  </svg>
                </a>
              </b>
              <b>
                h
                <a href="Siparis.html" title="Sipariş">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                  </svg>
                </a>
              </b>
              <b>
                v
                <a href="javascript:void(0);" title="">
                  <svg class="svg-icon" viewBox="0 0 20 20">
                    <path d="M19.432,7.157c-0.312-1.113-1.624-1.858-3.496-2.17c0.279,0.331,0.532,0.685,0.754,1.06c1.043,0.299,1.748,0.764,1.911,1.344c0.095,0.335,0.014,0.729-0.24,1.169c-0.274,0.476-0.768,1.007-1.455,1.542c0-0.034,0.005-0.067,0.005-0.101c0-3.816-3.094-6.91-6.91-6.91c-3.816,0-6.91,3.094-6.91,6.91c0,1.169,0.293,2.268,0.805,3.232c-1.366-0.277-2.303-0.805-2.495-1.487c-0.094-0.336-0.013-0.729,0.241-1.169c0.138-0.239,0.35-0.496,0.595-0.756c0.011-0.449,0.055-0.89,0.138-1.317c-1.398,1.144-2.112,2.386-1.805,3.476c0.338,1.205,1.845,1.98,3.968,2.24C5.8,15.854,7.774,16.91,10,16.91c3.389,0,6.201-2.44,6.791-5.659C18.735,9.951,19.795,8.448,19.432,7.157 M10,16.047c-1.651,0-3.147-0.664-4.238-1.738c0.147,0.005,0.295,0.008,0.447,0.008c1.502,0,3.195-0.212,4.941-0.658c1.734-0.443,3.297-1.064,4.595-1.776C14.952,14.299,12.682,16.047,10,16.047 M15.998,10.733c-1.27,0.797-2.973,1.554-5.062,2.088c-1.616,0.414-3.251,0.632-4.727,0.632c-0.427,0-0.827-0.025-1.213-0.061C4.338,12.425,3.954,11.258,3.954,10c0-3.339,2.707-6.046,6.046-6.046c3.34,0,6.047,2.708,6.047,6.046C16.047,10.249,16.027,10.492,15.998,10.733"></path>
                  </svg>
                </a>
              </b>
              <b>
                e
                <a href="javascript:void(0);" title="Öneriler">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.026A2 2 0 0 0 2 14h6.256A4.493 4.493 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586l-1.239-.757ZM16 4.697v4.974A4.491 4.491 0 0 0 12.5 8a4.49 4.49 0 0 0-1.965.45l-.338-.207L16 4.697Z" />
                    <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-3.5-2a.5.5 0 0 0-.5.5v1h-1a.5.5 0 0 0 0 1h1v1a.5.5 0 0 0 1 0v-1h1a.5.5 0 0 0 0-1h-1v-1a.5.5 0 0 0-.5-.5Z" />
                  </svg>
                </a>
              </b>
              <b>
                -
                <a href="Giris.html" title="Giriş">
                  <svg class="svg-icon" viewBox="0 0 20 20">
                    <path 
                      d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z" 
                    ></path>
                  </svg>
                </a>
              </b>
            </h1>
          </figcaption>
        </figure>
       </div>

<!------------------------------------------------------ KULLANICI KISMI BAŞLANGIÇ ----------------------------------------------------->

    <!-- Kullanıcı Paneli -->

        <div id="customerView" style="display: none;">
            <button id="goBackButton" class="hidden">Geri Dön</button>
       
            <div class="masa-container-customer">
                <div class="Body1 custom-table-layout" data-table="1">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 1</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
                <div class="Body1 custom-table-layout" data-table="2">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 2</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
                <div class="Body1 custom-table-layout" data-table="3">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 3</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
                <div class="Body1 custom-table-layout" data-table="4">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 4</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
                <div class="Body1 custom-table-layout" data-table="5">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 5</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
                <div class="Body1 custom-table-layout" data-table="6">
                    <div class="table-slot slot-top" data-slot-key="slot_1">BOŞ</div>
                    <div class="table-slot slot-left" data-slot-key="slot_3">BOŞ</div>
                    <div class="table-center">MASA 6</div>
                    <div class="table-slot slot-right" data-slot-key="slot_4">BOŞ</div>
                    <div class="table-slot slot-bottom" data-slot-key="slot_2">BOŞ</div>
                </div>
            </div>
            
            <div class="order-form" id="orderForm">


            
            <div id="customerActiveOrders" style="display:none; margin-top: 20px; padding: 15px; border-radius: 8px;">
                <h3 style="text-align:center; color: rgb(77, 51, 9);">Aktif Siparişlerim</h3>
                <ul id="customerOrdersList" style="list-style-type: none; padding: 0;">
                    <!-- Active orders will be listed here -->
                </ul>
            </div>
            <h2>SİPARİŞ PANELİ</h2>
    <div class="coffee-table">
        <div class="filters"> 
            <button onclick="loadCoffees('Sıcak Kahve')">Sıcak Kahve</button>
            <button onclick="loadCoffees('Soğuk Kahve')">Soğuk Kahve</button>
            <button onclick="loadCoffees('Sıcak Çay')">Sıcak Çay</button>
            <button onclick="loadCoffees('Soğuk Çay')">Soğuk Çay</button>
            <button onclick="loadCoffees('Diğer')">Diğer</button>
        </div>
        <table id="coffeeTable">
            <thead>
                <tr>
                    <th>Resim</th>
                    <th>İsim</th>
                    <th>Fiyat</th>
                    <th>Sipariş Ver</th>
                </tr>
            </thead>
            <tbody>
                <!-- Coffee items will be loaded here by JavaScript -->
            </tbody>
        </table>
    </div>

        </div>
    </div> <!-- End of customerView -->

    <div id="personnelView" style="display: none;">
        <h2>Personel Sipariş Takip Paneli</h2>
        <!-- Order display for personnel will be dynamically generated here -->
        <!-- Example structure for displaying orders per table -->
        <div class="table-orders-container">
            <!-- Masa 1 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="1">
                <div class="Body3Title-personnel">MASA 1</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
            <!-- Masa 2 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="2">
                <div class="Body3Title-personnel">MASA 2</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
            <!-- Masa 3 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="3">
                <div class="Body3Title-personnel">MASA 3</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
            <!-- Masa 4 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="4">
                <div class="Body3Title-personnel">MASA 4</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
            <!-- Masa 5 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="5">
                <div class="Body3Title-personnel">MASA 5</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
            <!-- Masa 6 Siparişleri -->
            <div class="Body3-personnel" data-table-personnel="6">
                <div class="Body3Title-personnel">MASA 6</div>
                <div class="Body3Body-personnel">Siparişler yükleniyor...</div>
            </div>
        </div>
    </div> <!-- End of personnelView -->

<!------------------------------------------------------ KULLANICI KISMI SON ----------------------------------------------------->

</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    let currentUserSessionRef = null;
    let currentUserID = null;
    let currentDeviceSessionID = null;
    let sessionListenerActive = false; // To manage listener state during logout or conflicts

    const mainContainer = document.querySelector('.Container');
    const customerView = document.getElementById('customerView');
    const personnelView = document.getElementById('personnelView');

    if (mainContainer) mainContainer.style.display = 'none'; // Hide main container initially
    if (customerView) customerView.style.display = 'none';
    if (personnelView) personnelView.style.display = 'none';

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            currentUserID = user.uid; // Store current user ID

            // Handle device session ID
            currentDeviceSessionID = localStorage.getItem('deviceSessionID');
            if (!currentDeviceSessionID) {
                currentDeviceSessionID = firebase.database().ref().push().key; // Generate a unique ID if not present
                localStorage.setItem('deviceSessionID', currentDeviceSessionID);
            }
            console.log("Current device session ID:", currentDeviceSessionID);

            const userSessionDbRef = firebase.database().ref('users/' + currentUserID + '/activeDeviceSessionID');
            
            // Set this device's session ID as active in the database
            userSessionDbRef.set(currentDeviceSessionID).then(() => {
                console.log('Active session ID successfully set in DB for this device:', currentDeviceSessionID);
            }).catch(error => {
                console.error('Error setting active session ID in DB:', error);
            });

            // Detach any existing listener before attaching a new one
            if (currentUserSessionRef) {
                currentUserSessionRef.off();
                console.log("Detached previous session listener for user:", currentUserID);
            }
            
            currentUserSessionRef = firebase.database().ref('users/' + currentUserID + '/activeDeviceSessionID');
            sessionListenerActive = true; // Mark listener as active for the current user
            console.log("Attaching session listener for user:", currentUserID);

            currentUserSessionRef.on('value', (snapshot) => {
                if (!sessionListenerActive) {
                    console.log('Session listener is not active for this device, ignoring value event.');
                    return;
                }
                
                const sessionIDFromDB = snapshot.val();
                console.log('Session ID from DB changed to:', sessionIDFromDB, '| Current device session ID:', currentDeviceSessionID);

                if (sessionIDFromDB && currentDeviceSessionID && sessionIDFromDB !== currentDeviceSessionID) {
                    console.log('Session conflict detected. This device session ID:', currentDeviceSessionID, 'DB session ID:', sessionIDFromDB, '. Logging out from this device.');
                    
                    sessionListenerActive = false; // Deactivate listener for this device
                    if (currentUserSessionRef) {
                        currentUserSessionRef.off(); // Detach listener
                        currentUserSessionRef = null;
                         console.log("Detached session listener due to conflict.");
                    }
                    
                    firebase.auth().signOut().then(() => {
                        // onAuthStateChanged will handle redirection.
                        // Alert is placed here to ensure it's shown before navigation by onAuthStateChanged.
                        alert('Oturumunuz başka bir cihazda açıldığı için bu cihazdaki oturum sonlandırıldı.');
                    }).catch(error => {
                        console.error('Error signing out due to session conflict:', error);
                        // If sign out fails, the user might still be technically logged in here.
                        // Re-evaluate if the listener should be re-enabled or redirect anyway.
                        // For now, onAuthStateChanged should eventually redirect if signout was successful.
                    });
                }
            }, (error) => {
                console.error("Error in session listener:", error);
            });

            const userId = user.uid; // userId already defined, using currentUserID for consistency
            const userRoleRef = firebase.database().ref('users/' + userId + '/role');

            userRoleRef.once('value').then(snapshot => {
                const role = snapshot.val();
                console.log("User Authenticated. UID:", userId, "Role:", role);
                if (mainContainer) mainContainer.style.display = ''; // Show main container

                if (role === 'admin' || role === 'employee') {
                    console.log("Initializing personnel panel.");
                    if (customerView) customerView.style.display = 'none';
                    if (personnelView) personnelView.style.display = 'block'; // Use 'block' or 'flex' depending on layout needs
                    initializePersonnelPanel();
                } else if (role === 'user' || role === 'customer') {
                    console.log("User is customer. Initializing customer panel.");
                    if (personnelView) personnelView.style.display = 'none';
                    if (customerView) customerView.style.display = 'block'; // Use 'block' or 'flex'
                    initializeCustomerPanel();
                } else {
                    console.log('User role not found or not recognized (", role, "). Redirecting to login.');
                    window.location.href = 'Giris.html';
                }
            }).catch(error => {
                console.error("Error fetching user role: ", error);
                window.location.href = 'Giris.html';
            });
        } else { // User is signed out or auth state changed to no user
            console.log('No user signed in or user signed out.');
            sessionListenerActive = false; // Deactivate listener for any previous user

            if (currentUserSessionRef) {
                currentUserSessionRef.off();
                currentUserSessionRef = null;
                console.log("Detached session listener on logout/auth state change to no user.");
            }

            // Attempt to clear activeDeviceSessionID from DB only if this device held that session
            if (currentUserID && currentDeviceSessionID) {
                const userSessionDbRefToClear = firebase.database().ref('users/' + currentUserID + '/activeDeviceSessionID');
                userSessionDbRefToClear.once('value').then(snapshot => {
                    if (snapshot.val() === currentDeviceSessionID) {
                        console.log('This device was the active session holder. Removing session ID from DB.');
                        userSessionDbRefToClear.remove().then(() => {
                            console.log('Active session ID removed from DB for user:', currentUserID);
                        }).catch(error => {
                            console.error('Error removing active session ID from DB for user:', currentUserID, error);
                        });
                    } else {
                        console.log('This device was NOT the active session holder. Not removing session ID from DB.');
                    }
                }).catch(error => {
                    console.error('Error checking session ID before removal on logout for user:', currentUserID, error);
                });
            }

            localStorage.removeItem('deviceSessionID');
            console.log("Removed deviceSessionID from localStorage.");
            currentUserID = null; // Reset global currentUserID
            currentDeviceSessionID = null; // Reset global currentDeviceSessionID
            
            console.log('No user signed in. Redirecting to login.');
            window.location.href = 'Giris.html';
        }
    });

    window.addEventListener('beforeunload', function (e) {
        const masaNumToClear = window.activeMasaNumarasi;
        const slotKeyToClear = window.activeSlotKey;
        const slotSessionIDToCancel = window.activeSlotOrderID;

        if (masaNumToClear && slotKeyToClear) {
            console.log(`beforeunload: Attempting to clear Masa ${masaNumToClear}, Slot ${slotKeyToClear}. Session ID: ${slotSessionIDToCancel || 'N/A'}`);

            // Directly update the Masalar table to clear the slot
            // This is the most critical operation for this event
            const tableSlotRefToClear = firebase.database().ref(`Masalar/${masaNumToClear}/slots/${slotKeyToClear}`);
            tableSlotRefToClear.set({
                Name: null,
                Order_ID: null,
                status: "available"
            }).then(() => {
                console.log(`beforeunload: Successfully set Masalar/${masaNumToClear}/slots/${slotKeyToClear} to available.`);
            }).catch(error => {
                console.error(`beforeunload: Error setting Masalar/${masaNumToClear}/slots/${slotKeyToClear} to available:`, error);
            });

            // Attempt to delete orders associated with this slot. This is a secondary, best-effort operation.
            // First, try by session ID if available
            if (slotSessionIDToCancel) {
                const sessionOrdersQuery = firebase.database().ref('orders')
                                            .orderByChild('slot_session_id')
                                            .equalTo(slotSessionIDToCancel);
                sessionOrdersQuery.once('value').then(snapshot => {
                    const updates = {};
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            if (childSnapshot.val().status === 'pending') {
                                updates[`orders/${childSnapshot.key}`] = null;
                            }
                        });
                        firebase.database().ref().update(updates)
                            .then(() => console.log(`beforeunload: Pending orders for session ${slotSessionIDToCancel} deleted.`))
                            .catch(err => console.error(`beforeunload: Error deleting session orders for ${slotSessionIDToCancel}:`, err));
                    }
                }).catch(err => console.error(`beforeunload: Error querying session orders for ${slotSessionIDToCancel}:`, err));
            }

            // Second, do a general cleanup for any other pending orders in this specific slot.
            const generalSlotOrdersQuery = firebase.database().ref('orders')
                                        .orderByChild('masa_id')
                                        .equalTo(masaNumToClear);
            generalSlotOrdersQuery.once('value').then(snapshot => {
                const updates = {};
                if (snapshot.exists()){
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        if (order.slot_key === slotKeyToClear && order.status === 'pending') {
                            updates[`orders/${childSnapshot.key}`] = null;
                        }
                    });
                    firebase.database().ref().update(updates)
                        .then(() => console.log(`beforeunload: General orphaned orders for Masa ${masaNumToClear}, Slot ${slotKeyToClear} deleted.`))
                        .catch(err => console.error(`beforeunload: Error deleting general orphaned orders for ${masaNumToClear}, ${slotKeyToClear}:`, err));
                }
            }).catch(err => console.error(`beforeunload: Error querying general orphaned orders for ${masaNumToClear}, ${slotKeyToClear}:`, err));

        } else {
            console.log("beforeunload: No active customer masa/slot detected. No slot cleanup needed.");
        }
        // Synchronous return for 'beforeunload'. Firebase operations are async and best-effort.
    });
});



function initializePersonnelPanel() {
    console.log("Initializing personnel panel UI and event listeners...");
    const personnelViewTitle = document.querySelector("#personnelView h2");
    if (personnelViewTitle) {
        personnelViewTitle.textContent = "Personel Sipariş Takip Paneli"; // Simpler title
    }
    loadPersonnelOrders(); 
}


</script>

<script src="SiparisCustomer.js"></script>
<script src="SiparisPersonel.js"></script>

<script src="LoadCoffees.js"></script>
<script src="OrderCoffe.js"></script>


</body>
</html>
